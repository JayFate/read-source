关于实现 ADB 的注意事项。
I. 概述：
Android Debug Bridge（ADB）用于：

- 跟踪所有连接到或在给定的宿主开发机器上运行的 Android 设备和模拟器实例
- 实现各种控制命令（例如 "adb shell", "adb pull" 等）以便于客户端（命令行用户，或像 DDMS 这样的辅助程序）使用。这些命令在 ADB 中被称为 'services'。
  总的来说，所有工作都通过以下组件进行：
  1. ADB 服务器
      这是一个在宿主机上运行的后台进程。它的目的是感应 USB 端口，以了解何时连接或移除设备，以及何时启动或停止模拟器实例。
      因此，它维护了一个“连接设备”的列表，并为每个设备分配了一个“状态”：OFFLINE, BOOTLOADER, RECOVERY or ONLINE（下面将详细介绍）。
      ADB 服务器实际上是一个巨大的多路复用循环，其目的是协调客户端、服务和设备之间数据（实际上是数据包）的交换。
  2. ADB 守护进程（adbd）
      'adbd' 程序作为后台进程在 Android 设备或模拟系统中运行。它的目的是通过 USB（对于设备）或 TCP（对于模拟器）连接到 ADB 服务器，并向在宿主上运行的客户端提供一些服务。
      当设备成功连接到其中的 adbd 程序时，ADB 服务器认为该设备是在线的。否则，设备是离线的，这意味着 ADB 服务器检测到一个新的设备/模拟器，但无法连接到 adbd 守护进程。
      启动引导程序和恢复状态对应于设备处于启动引导程序或恢复模式时的替代状态。
  3. ADB 命令行客户端
      'adb' 命令行程序用于从 shell 或脚本中运行 adb 命令。它首先尝试在宿主机上定位 ADB 服务器，并在未找到时自动启动一个。
      然后，客户端将其服务请求发送到 ADB 服务器。
      目前，单个 'adb' 二进制文件用于服务器和客户端。
      这使得分发和启动服务器更加容易。
  4. 服务
      客户端可以与之通信的服务基本上有两种。
      宿主服务：
      这些服务在 ADB 服务器内运行，因此不需要与设备通信。一个典型的例子是 "adb devices"，它用于返回当前已知设备及其状态的列表。尽管如此，还有其他一些服务。
      本地服务：
      这些服务要么在 adbd 守护进程内运行，要么由其在设备上启动。ADB 服务器用于在客户端和服务在 adbd 上运行之间多路复用流。在这种情况下，它的作用是启动连接，然后成为数据的通道。

II. 协议细节：
  1. 客户端 <-> 服务器协议：

    本节详细介绍了 ADB 客户端和 ADB 服务器本身之间使用的协议。ADB 服务器监听在 TCP:localhost:5037。
    客户端使用以下格式发送请求：
        1. 一个 4 字节的十六进制字符串，给出有效载荷的长度
        2. 然后是有效载荷本身。
    例如，要查询 ADB 服务器的内部版本号，客户端将执行以下操作：
        1. 连接到 tcp:localhost:5037
        2. 向相应的套接字发送字符串 "000Chost:version"
    '000C' 表示十六进制有效载荷的长度，转换为十进制为 12
    'host:' 前缀用于指示请求是直接发送给服务器本身（我们稍后将讨论其他类型的请求）。
    内容长度以 ASCII 编码以便于调试。
    服务器应使用以下之一回答请求：
        1. 成功时，4 字节的 "OKAY" 字符串
        2. 失败时，4 字节的 "FAIL" 字符串，然后是一个 4 字节的十六进制长度，然后是一个给出失败原因的字符串。
    请注意，在 OKAY 之后连接仍然处于活动状态，这允许客户端进行其他请求。但在某些情况下，OKAY 甚至会改变连接的状态。
    例如，在 'host:transport:<serialnumber>' 请求的情况下，'<serialnumber>' 用于标识给定的设备/模拟器；在 "OKAY" 回答之后，客户端进一步做出的所有请求将直接发送到相应的 adbd 守护进程。
    文件 SERVICES.TXT 列出了 ADB 当前实现的所有服务。
  2. 传输：

    ADB 传输模拟了 ADB 服务器和一台设备或模拟器之间的连接。目前有两种传输方式：
       - USB 传输，用于通过 USB 连接的物理设备
       - 本地传输，用于在宿主上运行并通过 TCP 连接到服务器的模拟器
    理论上，应该可以编写一个本地传输，代理 ADB 服务器和连接到/在另一台机器上运行的设备/模拟器之间的连接。尽管如此，这还没有完成。
    每个传输可以承载一个或多个客户端和它们指向的设备/模拟器之间的多路复用流。ADB 服务器必须正确处理意外的传输断开连接（例如，当设备被物理拔出时）。



原文：https://android.googlesource.com/platform/packages/modules/adb/+/refs/heads/main/OVERVIEW.TXT
